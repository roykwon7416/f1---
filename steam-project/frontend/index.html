<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteamSpy ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <header>
        <h1>SteamSpy ê²Œì„ ë¶„ì„</h1>
    </header>
    <aside id="controls">
        <div class="control-group">
            <h2>ë¶„ì„ ì„¤ì •</h2>
            <div>
                <label>ë¶„ì„ í•­ëª©:</label><br>
                <label><input type="radio" name="metric" value="owners" checked> ì†Œìœ ì ìˆ˜</label>
                <label><input type="radio" name="metric" value="players_2weeks"> ìµœê·¼ 2ì£¼ê°„ í”Œë ˆì´ì–´ ìˆ˜</label>
                <label><input type="radio" name="metric" value="average_playtime"> í‰ê·  í”Œë ˆì´íƒ€ì„</label>
            </div>
            <div>
                <label for="topN">ìƒìœ„ Nê°œ ê²Œì„:</label>
                <input type="range" id="topN" min="5" max="50" value="10">
                <span id="topNValue">10</span>
            </div>
        </div>
        <div class="control-group">
            <h2>í•„í„° ë° ë‹¤ìš´ë¡œë“œ</h2>
            <div>
                <label for="genreFilter">ì¥ë¥´ ì„ íƒ:</label><br>
                <select id="genreFilter" multiple></select>
            </div>
            <div>
                <label for="minTimeFilter">ìµœì†Œ í‰ê·  í”Œë ˆì´íƒ€ì„(ë¶„):</label><br>
                <input type="number" id="minTimeFilter" min="0" value="0">
            </div>
            <button id="applyFilterBtn">í•„í„° ì ìš©</button>
            <button id="downloadCsv">CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </aside>

    <main>
        <section id="topGamesSection">
            <h2>ğŸ® ìƒìœ„ ì¸ê¸° ê²Œì„ ëª©ë¡</h2>
            <div id="topGamesTableContainer">
                <table id="topGamesTable">
                    <thead>
                        <tr>
                            <th>ì•± ID</th><th>ê²Œì„ ì´ë¦„</th><th>ì¥ë¥´</th><th>ì†Œìœ ì ìˆ˜</th><th>ìµœê·¼ 2ì£¼ê°„ í”Œë ˆì´ì–´ ìˆ˜</th><th>í‰ê·  í”Œë ˆì´íƒ€ì„</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="topGamesChart"></div>
        </section>

        <section id="genreSummarySection">
            <h2>ğŸ“Š ì¥ë¥´ë³„ ìš”ì•½ ë¶„ì„</h2>
            <div id="genreChart"></div>
        </section>

        <section id="filterSection">
            <h2>ğŸ” ë°ì´í„° í•„í„°ë§ ê²°ê³¼</h2>
            <div id="filteredTableContainer"></div>
        </section>

        <section id="detailSection">
            <h2>ğŸ“˜ ê²Œì„ ìƒì„¸ ì •ë³´</h2>
            <select id="gameSelect"></select>
            <div id="gameDetail"></div>
        </section>
    </main>

    <script>
        let gamesData = [];
        let filteredData = [];

        async function loadData() {
            const res = await fetch('/api/top-games');
            gamesData = await res.json();
            initControls();
            applyAnalysis();
            applyFilter();
        }

        function initControls() {
            const genreFilter = document.getElementById('genreFilter');
            const genres = [...new Set(gamesData.map(g => g.genre))].sort();
            genres.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                genreFilter.appendChild(opt);
            });
            const topN = document.getElementById('topN');
            const topNValue = document.getElementById('topNValue');
            topN.addEventListener('input', () => {
                topNValue.textContent = topN.value;
                applyAnalysis();
            });
            document.getElementsByName('metric').forEach(r => r.addEventListener('change', applyAnalysis));
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
            document.getElementById('downloadCsv').addEventListener('click', downloadCsv);
        }

        function applyAnalysis() {
            const metric = document.querySelector('input[name="metric"]:checked').value;
            const topN = parseInt(document.getElementById('topN').value);
            const sorted = [...gamesData].sort((a, b) => b[metric] - a[metric]).slice(0, topN);
            renderTable('topGamesTable', sorted);
            renderChart('topGamesChart', sorted.map(g => g.name), sorted.map(g => g[metric]), metric);
            renderGenreChart();
            initDetailSelect();
        }

        function renderTable(tableId, data) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            data.forEach(g => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${g.appid}</td>
                    <td>${g.name}</td>
                    <td>${g.genre}</td>
                    <td>${g.owners.toLocaleString()}</td>
                    <td>${g.players_2weeks.toLocaleString()}</td>
                    <td>${g.average_playtime.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderChart(divId, xData, yData, metric) {
            const label = { owners: 'ì†Œìœ ì ìˆ˜', players_2weeks: 'ìµœê·¼ 2ì£¼ê°„ í”Œë ˆì´ì–´ ìˆ˜', average_playtime: 'í‰ê·  í”Œë ˆì´íƒ€ì„' }[metric];
            Plotly.newPlot(divId, [{ x: xData, y: yData, type: 'bar' }], { title: `ìƒìœ„ ${document.getElementById('topN').value}ê°œ ê²Œì„ë³„ ${label}`, xaxis: { tickangle: -45 }, height: 500 });
        }

        function renderGenreChart() {
            const agg = {};
            gamesData.forEach(g => {
                if (!agg[g.genre]) agg[g.genre] = { players: 0 };
                agg[g.genre].players += g.players_2weeks;
            });
            const genres = Object.keys(agg);
            const players = genres.map(gn => agg[gn].players);
            Plotly.newPlot('genreChart', [{ x: genres, y: players, type: 'bar' }], { title: 'ì¥ë¥´ë³„ ì´ í”Œë ˆì´ì–´ ìˆ˜', xaxis: { tickangle: -45 }, height: 400 });
        }

        function applyFilter() {
            const selGenres = Array.from(document.getElementById('genreFilter').selectedOptions).map(o => o.value);
            const minTime = parseInt(document.getElementById('minTimeFilter').value) || 0;
            filteredData = gamesData.filter(g => (selGenres.length === 0 || selGenres.includes(g.genre)) && g.average_playtime >= minTime);
            const container = document.getElementById('filteredTableContainer');
            let html = `<table><thead><tr><th>ì•± ID</th><th>ê²Œì„ ì´ë¦„</th><th>ì¥ë¥´</th><th>ì†Œìœ ì ìˆ˜</th><th>2ì£¼ í”Œë ˆì´ì–´</th><th>í‰ê·  í”Œë ˆì´íƒ€ì„</th></tr></thead><tbody>`;
            filteredData.forEach(g => { html += `<tr><td>${g.appid}</td><td>${g.name}</td><td>${g.genre}</td><td>${g.owners.toLocaleString()}</td><td>${g.players_2weeks.toLocaleString()}</td><td>${g.average_playtime.toLocaleString()}</td></tr>`; });
            html += '</tbody></table>';
            container.innerHTML = html;
            initDetailSelect();
        }

        function downloadCsv() {
            const data = filteredData.length ? filteredData : gamesData;
            const header = ['appid','name','genre','owners','players_2weeks','average_playtime'];
            const rows = data.map(r => [r.appid,r.name,r.genre,r.owners,r.players_2weeks,r.average_playtime].join(','));
            const csv = [header.join(','), ...rows].join('\n');
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'steamspy_data.csv'; a.click(); URL.revokeObjectURL(url);
        }

        function initDetailSelect() {
            const select = document.getElementById('gameSelect');
            const data = filteredData.length ? filteredData : gamesData;
            select.innerHTML = '';
            data.forEach(g => { const opt = document.createElement('option'); opt.value = g.appid; opt.textContent = g.name; select.appendChild(opt); });
            select.addEventListener('change', renderDetail);
            renderDetail();
        }

        function renderDetail() {
            const id = parseInt(document.getElementById('gameSelect').value);
            const data = filteredData.length ? filteredData : gamesData;
            const g = data.find(item => item.appid === id);
            const div = document.getElementById('gameDetail');
            if (g) {
                div.innerHTML = `
                    <p><strong>ì¥ë¥´:</strong> ${g.genre}</p>
                    <p><strong>ì†Œìœ ì ìˆ˜:</strong> ${g.owners.toLocaleString()}</p>
                    <p><strong>ìµœê·¼ 2ì£¼ê°„ í”Œë ˆì´ì–´ ìˆ˜:</strong> ${g.players_2weeks.toLocaleString()}</p>
                    <p><strong>í‰ê·  í”Œë ˆì´íƒ€ì„:</strong> ${g.average_playtime.toLocaleString()}ë¶„</p>
                `;
            } else {
                div.textContent = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
